<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=<device-width>, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="./style.css" />
    <script src="start.js"></script>
  </head>
  <body>
    <script
      type="module"
      src="https://unpkg.com/@google/model-viewer/dist/model-viewer.js"
    ></script>

    
    <model-viewer
      class="model-style"
      style="width: 100vw; height: 100vh; overflow: hidden;"
      camera-controls
      touch-action="pan-y"
      autoplay
      animation-name="Running"
      ar
      shadow-intensity="1"
      src="./old_rusty_car_2/AR_Car_Android11.glb"
      alt="An animated 3D model of a robot"
      camera-orbit="54deg 75deg auto"
      ar-modes="webxr scene-viewer quick-look"
      scale = "-1 1 -1"
    >
    <button 
    id="buttonToggle1"
    class="Hotspot button-style1"
    onclick="playAnimtionFirst()"
    slot="hotspot-1" 
    data-position="0.18m 0.15m 0.25m" 
    data-normal="2m 20m 20m" 
    data-visibility-attribute="visible">
    <img class="image-style" src="./Play-Button.png"></img>
    <!-- <div class="HotspotAnnotation">animation1</div> -->
    </button>

    <button 
    id="buttonToggle2"
    class="Hotspot button-style1"
    onclick="playAnimtionSecond()"
    slot="hotspot-2" 
    data-position="-0.18m 0.15m 0m" 
    data-normal="2m 20m 20m" 
    data-visibility-attribute="visible">
    <img class="image-style" src="./Play-Button.png"></img>
    <!-- <div class="HotspotAnnotation">animation2</div> -->
    </button>

    <button 
    id="buttonToggle3"
    class="Hotspot button-style2"
    onclick="hideButton()"
    slot="hotspot-3" 
    data-position="0m 0.325m 0m" 
    data-normal="2m 20m 20m" 
    data-visibility-attribute="visible">
    <img class="image-style" src="./UI.png"></img>
    <!-- <div class="HotspotAnnotation">hide</div> -->
    </button>


  </model-viewer>

    <script>
      var isVisible = true;
      var isFirstAnimationActive = false;
      var isSecondAnimationActive = false;
      var isPlayAnimation = false;
      const modelViewer = document.querySelector("model-viewer");

      //On window or broswer on start
      window.addEventListener("load",onLoadFunctions);

      function onLoadFunctions()
      {
        //on load or on start animation pause.
        modelViewer.addEventListener('load', ()=> { 
          pauseAnimation();

        });
        //on finish animation
        // modelViewer.addEventListener("loop",()=>{
        //   console.log("finsih animation")
        //   pauseAnimation()
        // });
      }

      // ========= endTargetFrameAnimation ==========

      async function StartAndStopAnimationAtTargetFrame(startCurrent,stopCurrent){
      // console.log("startCurrent :" + startCurrent + "{}" +"stopCurrent:" + stopCurrent)
      isPlayAnimation = true;
      const result = await checkAnimationShouldForward(startCurrent,stopCurrent);
      startAnimation(result,startCurrent,stopCurrent);
      }

      function checkAnimationShouldForward(startC,stopC)
      {
        return new Promise((resolve, reject) => {
          setTimeout(() => {
            var isForwarAnimation;
      if(startC < stopC)
      {
        console.log("foward");
        isForwarAnimation = true;
      }
      else
      {
        console.log("backward");
        isForwarAnimation = false;
      }
            resolve(isForwarAnimation)
            modelViewer.currentTime = startC;
          }, 2000)
      })
      }
      
      function startAnimation(isForward,startC,stopC)
      {
        if(isForward)
        {
          modelViewer.timeScale = 1;
          console.log("modelViewer.timeScale:" + modelViewer.timeScale);
        }
        else
        {
          modelViewer.timeScale = -1;
          console.log("modelViewer.timeScale:" + modelViewer.timeScale);
        }
        playAnimation();
        var timerInterval = window.setInterval(() =>{
          // console.log(modelViewer.currentTime);
          // console.log("startCurrent :" + startCurrent);
          if(isForward)
          {
            if((modelViewer.currentTime > stopC ))
            {
              clearInterval(timerInterval);
              pauseAnimation();
              isPlayAnimation = false;
              console.log("stop foward");
            }
          }
          else
          {
            if((modelViewer.currentTime < stopC ))
            {
              clearInterval(timerInterval);
              pauseAnimation();
              isPlayAnimation = false;
              console.log("stop backward");
            }
          }
        }
        , 60);
      }

      function pauseAnimation() {
        modelViewer.pause();
      }

      function playAnimation() {
        modelViewer.play();
      }

      function playAnimtionFirst() {
      if(!isPlayAnimation)
      {
        if(!isFirstAnimationActive)
        {
          StartAndStopAnimationAtTargetFrame(0.5,2);
        }
        else
        {
          StartAndStopAnimationAtTargetFrame(2,0.5);
        }
        isFirstAnimationActive = !isFirstAnimationActive;
      }
    }
      
      function playAnimtionSecond()
      {
        if(!isPlayAnimation)
        {
        if(!isSecondAnimationActive )
        {
          StartAndStopAnimationAtTargetFrame(3,4.25);
        }
      }
      }

      function hideButton()
      {
        const buttonToggle1 = document.getElementById("buttonToggle1");
        const buttonToggle2 = document.getElementById("buttonToggle2");
        if(isVisible)
        {
          buttonToggle1.style.visibility = "hidden";
          buttonToggle2.style.visibility = "hidden";
          isVisible = false;
        }
        else
        {
          buttonToggle1.style.visibility = "visible";
          buttonToggle2.style.visibility = "visible";
          isVisible = true;
        }
        modelViewer.animationName = "Wave";
      }
    </script>
    <!-- <button onclick="changeAnimation()">change Animation</button>
    <button onclick="stopAnimation()">stop Animation</button>
    <button onclick="playAnimation()">play Animation</button> -->
  </body>
</html>
